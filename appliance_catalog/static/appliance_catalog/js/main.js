"use strict";angular.module("underscore",[]).factory("_",function(){return window._}),angular.module("moment",[]).factory("moment",function(){return window.moment}),angular.module("appCatalogApp.service",["ng.django.urls"]),angular.module("appCatalogApp",["underscore","moment","appCatalogApp.service","ui.bootstrap","toggle-switch","angularjs-dropdown-multiselect","truncate","ngSanitize"]).config(["$interpolateProvider","$httpProvider",function($interpolateProvider,$httpProvider){$interpolateProvider.startSymbol("[[").endSymbol("]]"),$httpProvider.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",$httpProvider.defaults.xsrfCookieName="csrftoken",$httpProvider.defaults.xsrfHeaderName="X-CSRFToken"}]),angular.module("appCatalogApp.service").factory("NotificationFactory",["$rootScope","$timeout","_",function($rootScope,$timeout,_){var factory={},messages={},loading={};return factory.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"===c?r:3&r|8;return v.toString(16)})},factory.addLoading=function(resourceName){loading[resourceName]=!0,$rootScope.$broadcast("appliance:notifyLoading")},factory.removeLoading=function(resourceName){delete loading[resourceName],$rootScope.$broadcast("appliance:notifyLoading")},factory.getMessages=function(){return messages},factory.getLoading=function(){return loading},factory.clearMessages=function(key){key=key||"all","all"===key?messages={}:messages[key]=[],$rootScope.$broadcast("appliance:notifyMessage")},factory.removeMessage=function(key,messageObj,id){"undefined"!=typeof id&&(key+=id);var msgs=messages[key];!msgs||msgs.length<1||(messages[key]=_.reject(msgs,function(m){return m._id===messageObj._id}),$rootScope.$broadcast("appliance:notifyMessage"))},factory.addMessage=function(key,message,type){var messageObj={};messageObj.body=message,messageObj.type=type,messageObj._id=factory.uuid(),"undefined"==typeof messages[key]&&(messages[key]=[]),messages[key].push(messageObj),$rootScope.$broadcast("appliance:notifyMessage");var duration="danger"===messageObj.type?0:5e3;duration>0&&$timeout(function(){factory.removeMessage(key,messageObj)},duration)},factory}]).factory("UtilFactory",["_","moment","NotificationFactory",function(_,moment,NotificationFactory){var factory={};return factory.getClass=function(allocation){var status=allocation.status.toLowerCase();return"pending"===status?"label label-warning":"rejected"===status?"label label-danger":"label label-success"},factory.isLoading=function(msgKey,model){if(!msgKey||!model)return!1;var key=msgKey+model.id;return"undefined"==typeof NotificationFactory.getLoading()[key]?!1:!0},factory.closeMessage=function(key,msg,id){id="undefined"==typeof id||null===id?"":id,key+=id,NotificationFactory.removeMessage(key,msg)},factory.isEmpty=function(obj){return"undefined"!=typeof obj&&obj?angular.isArray(obj)&&0===obj.length?!0:angular.isObject(obj)&&_.isEmpty(obj)?!0:!1:!0},factory.hasMessage=function(arr,type){var pass=!1;if("undefined"==typeof arr||null===arr||arr===[]||"undefined"==typeof type||null===type||""===type)return pass;for(var i in arr)if(arr[i].type===type){pass=!0;break}return pass},factory.getMessages=function(msgKey,model){if(!msgKey||!model)return[];var key=msgKey+model.id,msgs=NotificationFactory.getMessages()[key];return"undefined"!=typeof msgs&&msgs.length>0?msgs:[]},factory.search=function(appliances,searchKey){return searchKey?_.filter(appliances,function(appliance){searchKey=searchKey.toLowerCase();var pass=!1,name=appliance.name||"",description=appliance.description||"",author=appliance.author_name||"";return name.toLowerCase().indexOf(searchKey)>-1?pass=!0:description.toLowerCase().indexOf(searchKey)>-1?pass=!0:author.toLowerCase().indexOf(searchKey)>-1&&(pass=!0),pass}):angular.copy(appliances)},factory}]).factory("ApplianceFactory",["$http","_","moment","NotificationFactory","djangoUrl",function($http,_,moment,NotificationFactory,djangoUrl){var factory={};return factory.appliances=[],factory.appliance=null,factory.keywords=[],factory.getAppliances=function(keywords){var url=djangoUrl.reverse("appliance_catalog:get_appliances");if(keywords){url+="&";for(var i in keywords)url+="keywords="+keywords[i].id,i<keywords.length-1&&(url+="&")}var errorMsg="There was an error loading appliance catalog.";return NotificationFactory.clearMessages("appCatalog"),NotificationFactory.addLoading("appCatalog"),$http({method:"GET",url:url,cache:"true"}).then(function(response){NotificationFactory.removeLoading("appCatalog"),factory.appliances=response.data.result},function(){NotificationFactory.addMessage("appCatalog",errorMsg,"danger"),NotificationFactory.removeLoading("appCatalog")})},factory.getKeywords=function(){var errorMsg="There was an error loading keywords.";return NotificationFactory.clearMessages("keywords"),NotificationFactory.addLoading("keywords"),$http({method:"GET",url:djangoUrl.reverse("appliance_catalog:get_keywords"),cache:"true"}).then(function(response){NotificationFactory.removeLoading("keywords");var keywordsRaw=response.data.result;for(var i in keywordsRaw)factory.keywords.push({id:keywordsRaw[i].id,label:keywordsRaw[i].id})},function(){NotificationFactory.addMessage("keywords",errorMsg,"danger"),NotificationFactory.removeLoading("keywords")})},factory.getAppliance=function(appliance_id){var errorMsg="There was an error loading this appliance.";return NotificationFactory.clearMessages("appliance"),NotificationFactory.addLoading("appliance"),$http({method:"GET",url:djangoUrl.reverse("appliance_catalog:get_appliance",[appliance_id]),cache:"true"}).then(function(response){NotificationFactory.removeLoading("appliance"),factory.appliances=response.data.result},function(){NotificationFactory.addMessage("appliance",errorMsg,"danger"),NotificationFactory.removeLoading("appliance")})},factory}]),angular.module("appCatalogApp").controller("AppCatalogController",["$scope","$http","$timeout","moment","_","UtilFactory","ApplianceFactory","NotificationFactory",function($scope,$http,$timeout,moment,_,UtilFactory,ApplianceFactory,NotificationFactory){$scope.messages=[],$scope.$on("appliance:notifyMessage",function(){$scope.messages=NotificationFactory.getMessages()}),$scope.loading={},$scope.$on("appliance:notifyLoading",function(){$scope.loading=NotificationFactory.getLoading()}),$scope.close=UtilFactory.closeMessage,$scope.isEmpty=UtilFactory.isEmpty,$scope.hasMessage=UtilFactory.hasMessage,$scope.isLoading=UtilFactory.isLoading,$scope.getMessages=UtilFactory.getMessages,$scope.getClass=UtilFactory.getClass,$scope.viewType="grid",$scope.filterInit=function(){$scope.filter={selectedKeywords:[],searchKey:"",andSearch:!0}},$scope.filterInit(),$scope.sortAppliances=function(predicate){$scope.reverse?$scope.filteredAppliances=_.sortBy($scope.filteredAppliances,function(app){return app[predicate].toLowerCase()}):$scope.filteredAppliances=_.sortBy($scope.filteredAppliances,function(app){return app[predicate].toLowerCase()}).reverse()},$scope.appsPageChanged=function(pageNum){var startIndex=(pageNum-1)*$scope.appsPerPage,endIndex=startIndex+$scope.appsPerPage;endIndex>$scope.filteredAppliances.length-1&&(endIndex=$scope.filteredAppliances.length),$scope.appsThisPage=$scope.filteredAppliances.slice(startIndex,endIndex)},$scope.setupPagination=function(){$scope.appsPerPage=15,$scope.totalPages=Math.ceil($scope.filteredAppliances.length/$scope.appsPerPage),$scope.appsCurrentPage=1,$scope.appsPageChanged($scope.appsCurrentPage)},$scope.reset=function(){$scope.filterInit(),$scope.filteredAppliances=angular.copy($scope.appliances),$scope.orderInit(),$scope.sortAppliances($scope.predicate),$scope.setupPagination()},$scope.orderInit=function(){$scope.predicate="name",$scope.reverse=!0},$scope.orderInit(),$scope.appliances=[],$scope.filteredAppliances=[],$scope.getAppliances=function(){ApplianceFactory.getAppliances().then(function(){$scope.appliances=angular.copy(ApplianceFactory.appliances),$scope.filteredAppliances=angular.copy(ApplianceFactory.appliances),$scope.sortAppliances($scope.predicate),$scope.setupPagination()})},$scope.getAppliances(),$scope.getKeywords=function(){$scope.keywords=[],ApplianceFactory.getKeywords().then(function(){$scope.keywords=ApplianceFactory.keywords})},$scope.getKeywords(),$scope.getPageIndex=function(){var x=($scope.appsCurrentPage-1)*$scope.appsPerPage+1,y=$scope.appsCurrentPage*$scope.appsPerPage<$scope.filteredAppliances.length?$scope.appsCurrentPage*$scope.appsPerPage:$scope.filteredAppliances.length;return x+"-"+y},$scope.multiselectSettings={smartButtonMaxItems:15,scrollableHeight:"400px",scrollable:!0,enableSearch:!0,smartButtonTextConverter:function(itemText){return itemText.length>20?itemText.substring(0,17)+"...":itemText}},$scope.viewDetail=function(appId){window.location="detail/"+appId+"/"},$scope.multiselectCustomTexts={buttonDefaultText:"Search by keywords"},$scope.updateFiltered=function(){$scope.filter.selectedKeywords&&$scope.filter.selectedKeywords.length>0?ApplianceFactory.getAppliances($scope.filter.selectedKeywords).then(function(){$scope.filter.andSearch?$scope.filteredAppliances=UtilFactory.search(ApplianceFactory.appliances,$scope.filter.searchKey):$scope.filteredAppliances=_.union(UtilFactory.search($scope.appliances,$scope.filter.searchKey),ApplianceFactory.appliances),$scope.sortAppliances($scope.predicate),$scope.setupPagination()}):($scope.filteredAppliances=UtilFactory.search($scope.filteredAppliances,$scope.filter.searchKey),$scope.sortAppliances($scope.predicate),$scope.setupPagination())},$scope.changeOrder=function(predicate){$scope.predicate===predicate?$scope.reverse=!$scope.reverse:$scope.predicate=predicate,$scope.sortAppliances(predicate),$scope.setupPagination()},$scope.changeViewType=function(){"grid"===$scope.viewType?$scope.viewType="table":$scope.viewType="grid"}}]);