"use strict";angular.module("underscore",[]).factory("_",function(){return window._}),angular.module("moment",[]).factory("moment",function(){return window.moment}),angular.module("allocationsApp",["underscore","moment","ui.bootstrap"]).config(["$interpolateProvider","$httpProvider",function(a,b){a.startSymbol("[[").endSymbol("]]"),b.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",b.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",b.defaults.xsrfCookieName="csrftoken",b.defaults.xsrfHeaderName="X-CSRFToken"}]);var app=angular.module("allocationsApp");app.directive("readMore",function(){return{restrict:"A",transclude:!0,replace:!0,template:"<p></p>",scope:{moreText:"@",lessText:"@",words:"@",ellipsis:"@","char":"@",limit:"@",content:"@",textData:"@"},link:function(a,b,c){function d(){var a=i,d=/\s+/gi,j=i.length,k=i.trim().replace(d," ").split(" ").length,l="char",m=j,n=[],o=i,p="";angular.isUndefined(c.words)||(l="words",m=k),"words"===l?(n=i.split(/\s+/),n.length>h&&(i=n.slice(0,h).join(" ")+g,p=n.slice(h,m).join(" "),o=i+e+'<span class="more-text">'+p+f+"</span>")):m>h&&(i=a.slice(0,h)+g,p=a.slice(h,m),o=i+e+'<span class="more-text">'+p+f+"</span>"),b.append(o),b.find(".more-text").hide().removeClass("show-inline"),b.find(".read-more").on("click",function(){$(this).hide(),b.find(".more-text").addClass("show-inline").slideDown()}),b.find(".read-less").on("click",function(){b.find(".read-more").show(),b.find(".more-text").hide().removeClass("show-inline")})}var e=angular.isUndefined(a.moreText)?' <a class="read-more">Read More...</a>':' <a class="read-more">'+a.moreText+"</a>",f=angular.isUndefined(a.lessText)?' <a class="read-less">Less ^</a>':' <a class="read-less">'+a.lessText+"</a>",g=angular.isUndefined(a.ellipsis)?"":a.ellipsis,h=angular.isUndefined(a.limit)?50:a.limit,i=angular.isUndefined(a.textData)?"":a.textData.trim();d()}}}),app.directive("autodismiss",["$timeout",function(a){return{link:function(b,c,d){var e=7e3;d.autodismiss&&(e=parseInt(d.autodismiss)),d.$observe("trShow",function(){b.$eval(d.trShow)===!0&&a(function(){c.fadeOut(1e3)},e)})}}}]),angular.module("allocationsApp").controller("AllocationsController",["$scope","$http","_","$q","$timeout","$modal","$filter",function(a,b,c,d,e,f,g){a.projects=[],a.filteredProjects=[],a.loading={allocations:!0},a.loadingError={allocations:""},a.filter={active:!1,inactive:!1,pending:!1,rejected:!1,search:""},a.reset=function(){a.selectedProjects=a.projects,a.filter.active=!1,a.filter.inactive=!1,a.filter.pending=!1,a.filter.rejected=!1,a.filter.search=""},a.search=function(){return a.filter.search?c.filter(a.projects,function(b){var c=a.filter.search.toLowerCase(),d=!1,e=b.title||"",f=b.chargeCode||"",g=b.pi||!1;return e.toLowerCase().indexOf(c)>-1?d=!0:f.toLowerCase().indexOf(c)>-1?d=!0:g&&(g.lastName.toLowerCase().indexOf(c)>-1||g.firstName.toLowerCase().indexOf(c)>-1||g.username.toLowerCase().indexOf(c)>-1||g.email.toLowerCase().indexOf(c)>-1)&&(d=!0),d}):a.projects},a.updateSelected=function(){var b=[];for(var d in a.filter)a.filter[d]===!0&&b.push(d.toLowerCase());if(a.selectedProjects=a.search(),0!==b.length){var e=c.filter(a.selectedProjects,function(a){var d=!1;return c.each(a.allocations,function(a){a.doNotShow=!1;var e=a.status.toLowerCase();c.contains(b,e)?d=!0:a.doNotShow=!0}),d});a.selectedProjects=e}else c.each(a.selectedProjects,function(a){c.each(a.allocations,function(a){a.doNotShow=!1})})},a.getClass=function(a){var b=a.status.toLowerCase();return"pending"===b?"label label-warning":"rejected"===b?"label label-danger":"label label-success"},b({method:"GET",url:"/admin/allocations/view/",cache:"true"}).then(function(b){a.loading.allocations=!1,a.projects=b.data,a.selectedProjects=b.data},function(b){console.log("There was an error fetching allocations. "+b),a.loadingError.allocations="There was an error loading allocations.",a.loading.allocations=!1});var h=function(a){return Date.UTC(a.getFullYear(),a.getMonth(),a.getDate(),10,0,0,0)};a.approveAllocation=function(a,c){var d=angular.copy(a),e=f.open({templateUrl:"/admin/allocations/template/approval.html/",controller:"modalController",resolve:{data:function(){return{allocation:d,type:"approve"}}}});e.result.then(function(d){c.currentTarget.blur();var e=angular.copy(d.allocation);a.loadingApprove=!0,a.errorApprove=!1,a.successApprove=!1;try{delete e.loadingApprove,delete e.errorApprove,delete e.successApprove,delete e.doNotShow}catch(f){}e.status="Approved",e.start=g("date")(h(e.start),"yyyy-MM-ddTHH:mm:ss")+"Z",e.end=g("date")(h(e.end),"yyyy-MM-ddTHH:mm:ss")+"Z",e.dateReviewed=g("date")(h(new Date),"yyyy-MM-ddTHH:mm:ss")+"Z",b({method:"POST",url:"/admin/allocations/approval/",data:e}).then(function(b){console.log("response.data",b.data),a.loadingApprove=!1,"error"===b.data.status?a.errorApprove=!0:(a.successApprove=!0,a.computeAllocated=e.computeAllocated,a.storageAllocated=e.storageAllocated,a.memoryAllocated=e.memoryAllocated,a.start=e.start,a.end=e.end,a.decisionSummary=e.decisionSummary,a.status=e.status)},function(b){console.log("There was an error approving this allocation. "+b),a.errorApprove=!0,a.loadingApprove=!1})},function(){c.currentTarget.blur()})},a.rejectAllocation=function(a,c){var d=angular.copy(a),e=f.open({templateUrl:"/admin/allocations/template/approval.html/",controller:"modalController",resolve:{data:function(){return{allocation:d,type:"reject"}}}});e.result.then(function(d){c.currentTarget.blur();var e=angular.copy(d.allocation);a.loadingReject=!0,a.errorReject=!1,a.successReject=!1;try{delete e.loadingReject,delete e.errorReject,delete e.successReject,delete e.doNotShow}catch(f){}e.status="Rejected",e.dateReviewed=g("date")(h(new Date),"yyyy-MM-ddTHH:mm:ss")+"Z",b({method:"POST",url:"/admin/allocations/approval/",data:e}).then(function(b){console.log("response.data",b.data),a.loadingReject=!1,"error"===b.data.status?a.errorReject=!0:(a.successReject=!0,a.decisionSummary=e.decisionSummary,a.status=e.status)},function(b){console.log("There was an error rejecting this allocation. "+b),a.errorReject=!0,a.loadingReject=!1})},function(){c.currentTarget.blur()})}}]),angular.module("allocationsApp").controller("AllocationsController",["$scope","$http","_","$q","$timeout","$modal","moment",function(a,b,c,d,e,f,g){a.projects=[],a.filteredProjects=[],a.loading={allocations:!0},a.loadingError={allocations:""},a.filter={active:!1,inactive:!1,pending:!1,rejected:!1,search:""},a.reset=function(){a.selectedProjects=a.projects,a.filter.active=!1,a.filter.inactive=!1,a.filter.pending=!1,a.filter.rejected=!1,a.filter.search=""},a.search=function(){return a.filter.search?c.filter(a.projects,function(b){var c=a.filter.search.toLowerCase(),d=!1,e=b.title||"",f=b.chargeCode||"",g=b.pi||!1;return e.toLowerCase().indexOf(c)>-1?d=!0:f.toLowerCase().indexOf(c)>-1?d=!0:g&&(g.lastName.toLowerCase().indexOf(c)>-1||g.firstName.toLowerCase().indexOf(c)>-1||g.username.toLowerCase().indexOf(c)>-1||g.email.toLowerCase().indexOf(c)>-1)&&(d=!0),d}):a.projects},a.updateSelected=function(){var b=[];for(var d in a.filter)a.filter[d]===!0&&b.push(d.toLowerCase());if(a.selectedProjects=a.search(),0!==b.length){var e=c.filter(a.selectedProjects,function(a){var d=!1;return c.each(a.allocations,function(a){a.doNotShow=!1;var e=a.status.toLowerCase();c.contains(b,e)?d=!0:a.doNotShow=!0}),d});a.selectedProjects=e}else c.each(a.selectedProjects,function(a){c.each(a.allocations,function(a){a.doNotShow=!1})})},a.getClass=function(a){var b=a.status.toLowerCase();return"pending"===b?"label label-warning":"rejected"===b?"label label-danger":"label label-success"},b({method:"GET",url:"/admin/allocations/view/",cache:"true"}).then(function(b){a.loading.allocations=!1,a.projects=b.data,a.selectedProjects=b.data},function(b){console.log("There was an error fetching allocations. "+b),a.loadingError.allocations="There was an error loading allocations.",a.loading.allocations=!1}),a.toUTC=function(a){return g(a).format("YYYY-MM-DD")+"T05:00:00Z"},a.approveAllocation=function(c,d){var e=angular.copy(c),g=f.open({templateUrl:"/admin/allocations/template/approval.html/",controller:"modalController",resolve:{data:function(){return{allocation:e,type:"approve"}}}});g.result.then(function(e){d.currentTarget.blur();var f=angular.copy(e.allocation);c.loadingApprove=!0,c.errorApprove=!1,c.successApprove=!1;try{delete f.loadingApprove,delete f.errorApprove,delete f.successApprove,delete f.doNotShow}catch(g){}f.status="Approved",f.start=a.toUTC(f.start),f.end=a.toUTC(f.end),f.dateReviewed=a.toUTC(new Date),b({method:"POST",url:"/admin/allocations/approval/",data:f}).then(function(a){c.loadingApprove=!1,"error"===a.data.status?c.errorApprove=!0:(c.successApprove=!0,c.computeAllocated=f.computeAllocated,c.storageAllocated=f.storageAllocated,c.memoryAllocated=f.memoryAllocated,c.start=f.start,c.end=f.end,c.decisionSummary=f.decisionSummary,c.status=f.status)},function(a){console.log("There was an error approving this allocation. "+a),c.errorApprove=!0,c.loadingApprove=!1})},function(){d.currentTarget.blur()})},a.rejectAllocation=function(c,d){var e=angular.copy(c),g=f.open({templateUrl:"/admin/allocations/template/approval.html/",controller:"modalController",resolve:{data:function(){return{allocation:e,type:"reject"}}}});g.result.then(function(e){d.currentTarget.blur();var f=angular.copy(e.allocation);c.loadingReject=!0,c.errorReject=!1,c.successReject=!1;try{delete f.loadingReject,delete f.errorReject,delete f.successReject,delete f.doNotShow}catch(g){}f.status="Rejected",f.dateReviewed=a.toUTC(new Date),b({method:"POST",url:"/admin/allocations/approval/",data:f}).then(function(a){console.log("response.data",a.data),c.loadingReject=!1,"error"===a.data.status?c.errorReject=!0:(c.successReject=!0,c.decisionSummary=f.decisionSummary,c.status=f.status)},function(a){console.log("There was an error rejecting this allocation. "+a),c.errorReject=!0,c.loadingReject=!1})},function(){d.currentTarget.blur()})}}]),angular.module("allocationsApp").controller("modalController",["$scope","$modalInstance","$timeout","data",function(a,b,c,d){a.data=d,a.ok=function(){b.close(d)},a.cancel=function(){b.dismiss("cancel")},a.disabled=function(a,b){return!1},a.minStartDate=new Date,a.maxDate=angular.copy(a.minStartDate),a.maxDate=a.maxDate.setFullYear(a.maxDate.getFullYear()+10),a.open={start:!1,end:!1},a.open=function(b,c){b.preventDefault(),b.stopPropagation(),c=c.toLowerCase(),"start"===c?(a.open.start&&(a.open.start=!1),a.open.start=!0):"end"===c&&(a.open.end&&(a.open.end=!1),a.open.end=!0)},a.dateOptions={formatYear:"yy",startingDay:1},a.format="dd-MMMM-yyyy"}]);