"use strict";angular.module("underscore",[]).factory("_",function(){return window._}),angular.module("moment",[]).factory("moment",function(){return window.moment}),angular.module("highcharts",[]).factory("highcharts",function(){return window.Highcharts}),angular.module("usageApp.service",[]),angular.module("usageApp",["underscore","moment","highcharts","usageApp.service","ui.bootstrap","highcharts-ng"]).config(["$interpolateProvider","$httpProvider",function(a,b){a.startSymbol("[[").endSymbol("]]"),b.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",b.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",b.defaults.xsrfCookieName="csrftoken",b.defaults.xsrfHeaderName="X-CSRFToken"}]);var app=angular.module("usageApp");app.directive("readMore",function(){return{restrict:"A",transclude:!0,replace:!0,template:"<p></p>",scope:{moreText:"@",lessText:"@",words:"@",ellipsis:"@","char":"@",limit:"@",content:"@",textData:"@"},link:function(a,b,c){function d(){var a=i,d=/\s+/gi,j=i.length,k=i.trim().replace(d," ").split(" ").length,l="char",m=j,n=[],o=i,p="";angular.isUndefined(c.words)||(l="words",m=k),"words"===l?(n=i.split(/\s+/),n.length>h&&(i=n.slice(0,h).join(" ")+g,p=n.slice(h,m).join(" "),o=i+e+'<span class="more-text">'+p+f+"</span>")):m>h&&(i=a.slice(0,h)+g,p=a.slice(h,m),o=i+e+'<span class="more-text">'+p+f+"</span>"),b.append(o),b.find(".more-text").hide().removeClass("show-inline"),b.find(".read-more").on("click",function(){$(this).hide(),b.find(".more-text").addClass("show-inline").slideDown()}),b.find(".read-less").on("click",function(){b.find(".read-more").show(),b.find(".more-text").hide().removeClass("show-inline")})}var e=angular.isUndefined(a.moreText)?' <a class="read-more">Read More...</a>':' <a class="read-more">'+a.moreText+"</a>",f=angular.isUndefined(a.lessText)?' <a class="read-less">Less ^</a>':' <a class="read-less">'+a.lessText+"</a>",g=angular.isUndefined(a.ellipsis)?"":a.ellipsis,h=angular.isUndefined(a.limit)?50:a.limit,i=angular.isUndefined(a.textData)?"":a.textData.trim();d()}}}),angular.module("usageApp.service").factory("NotificationFactory",["$rootScope","$timeout","_",function(a,b,c){var d={},e={},f={};return d.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})},d.addLoading=function(b){f[b]=!0,a.$broadcast("allocation:notifyLoading")},d.removeLoading=function(b){delete f[b],a.$broadcast("allocation:notifyLoading")},d.getMessages=function(){return e},d.getLoading=function(){return f},d.clearMessages=function(b){b=b||"all","all"===b?e={}:e[b]=[],a.$broadcast("allocation:notifyMessage")},d.removeMessage=function(b,d,f){"undefined"!=typeof f&&(b+=f);var g=e[b];!g||g.length<1||(e[b]=c.reject(g,function(a){return a._id===d._id}),a.$broadcast("allocation:notifyMessage"))},d.addMessage=function(c,f,g){var h={};h.body=f,h.type=g,h._id=d.uuid(),"undefined"==typeof e[c]&&(e[c]=[]),e[c].push(h),a.$broadcast("allocation:notifyMessage");var i="danger"===h.type?0:5e3;i>0&&b(function(){d.removeMessage(c,h)},i)},d}]).factory("UtilFactory",["_","moment","NotificationFactory",function(a,b,c){var d={};return d.getClass=function(a){var b=a.status.toLowerCase();return"pending"===b?"label label-warning":"rejected"===b?"label label-danger":"label label-success"},d.isLoading=function(a,b){if(!a||!b)return!1;var d=a+b.id;return"undefined"==typeof c.getLoading()[d]?!1:!0},d.closeMessage=function(a,b,d){d="undefined"==typeof d||null===d?"":d,a+=d,c.removeMessage(a,b)},d.isEmpty=function(b){return"undefined"!=typeof b&&b?angular.isArray(b)&&0===b.length?!0:angular.isObject(b)&&a.isEmpty(b)?!0:!1:!0},d.hasMessage=function(a,b){var c=!1;if("undefined"==typeof a||null===a||a===[]||"undefined"==typeof b||null===b||""===b)return c;for(var d in a)if(a[d].type===b){c=!0;break}return c},d.getMessages=function(a,b){if(!a||!b)return[];var d=a+b.id,e=c.getMessages()[d];return"undefined"!=typeof e&&e.length>0?e:[]},d.search=function(b,c){return c?a.filter(b,function(a){var b=c.toLowerCase(),d=!1,e=a.title||"",f=a.chargeCode||"",g=a.pi||!1;return e.toLowerCase().indexOf(b)>-1?d=!0:f.toLowerCase().indexOf(b)>-1?d=!0:g&&(g.lastName.toLowerCase().indexOf(b)>-1||g.firstName.toLowerCase().indexOf(b)>-1||g.username.toLowerCase().indexOf(b)>-1||g.email.toLowerCase().indexOf(b)>-1)&&(d=!0),d}):angular.copy(b)},d.updateSelected=function(b,c,e){var f=[];for(var g in e)e[g]===!0&&f.push(g.toLowerCase());return c=d.search(b,e.search),0!==f.length?c=a.filter(c,function(b){var c=!1;return a.each(b.allocations,function(b){b.doNotShow=!0;var d=b.status.toLowerCase();a.contains(f,d)&&(b.doNotShow=!1,c=!0)}),c}):a.each(c,function(b){a.each(b.allocations,function(a){a.doNotShow=!1})}),c},d}]).factory("AllocationFactory",["$http","_","moment","NotificationFactory",function(a,b,c,d){var e={};return e.projects=[],e.userProjects=[],e.getAllocations=function(){var b="There was an error loading allocations.";return d.clearMessages("allocations"),d.addLoading("allocations"),a({method:"GET",url:"/admin/allocations/view/",cache:"true"}).then(function(a){d.removeLoading("allocations"),e.projects=a.data},function(){d.addMessage("allocations",b,"danger"),d.removeLoading("allocations")})},e.getUserAllocations=function(b){var c="There was an error loading user allocations.";return d.clearMessages("userAllocations"),d.addLoading("userAllocations"),a({method:"GET",url:"/admin/allocations/user/"+b+"/",cache:"true"}).then(function(a){d.removeLoading("userAllocations"),e.userProjects=a.data},function(){d.addMessage("userAllocations",c,"danger"),d.removeLoading("userAllocations")})},e.getProjectUsers=function(b){var c="projectUsers"+b.id,e="There was an error loading project users.";return d.clearMessages(c),d.addLoading(c),a({method:"GET",url:"/admin/usage/projects/"+b.id+"/users/",cache:"true"}).then(function(a){d.removeLoading(c),b.users=a.data},function(){d.addMessage(c,e,"danger"),d.removeLoading(c)})},e}]).factory("UsageFactory",["$http","_","moment","NotificationFactory",function(a,b,c,d){var e={};e.projects=[],e.userProjects=[],e.downtimes=[],e.usage=[];var f=function(a,c){var d={},e=[];b.each(c.data,function(a){a[0]in d?d[a[0]]+=a[1]:d[a[0]]=a[1]}),b.each(b.keys(d),function(a){var b=[];b[0]=parseInt(a,10),b[1]=d[a],e.push(b)}),a.selectedAllocation.usage=b.sortBy(e,function(a){return a[0]})},g=function(a,c){var d={},e=[],f=[];for(var g in c.data){var h=c.data[g],i=0;for(var j in h)b.contains(f,j)||f.push(j),i+=h[j];e.push({user:g,total:i})}e=b.sortBy(e,"total").reverse();var k=b.pluck(e,"user");b.each(k,function(a){b.each(f,function(b){var e=c.data[a][b]||0;d.hasOwnProperty(b)||(d[b]=[]),d[b].push(Math.round(100*e)/100)})}),a.selectedAllocation.usageUsers=k,a.selectedAllocation.usageByUsers=d};return e.getAllocationUsage=function(b){var c="allocationUsage"+b.id,e="There was an error loading allocation usage.";return d.clearMessages(c),d.addLoading(c),a({method:"GET",url:"/admin/usage/allocation/"+b.selectedAllocation.id+"/",cache:"true"}).then(function(a){d.removeLoading(c),f(b,a)},function(){d.addMessage(c,e,"danger"),d.removeLoading(c)})},e.getUsageByUsers=function(b){var e="usageByUsers"+b.id,f="There was an error loading usage by users.";d.clearMessages(e),d.addLoading(e);var h=c(b.from).utc().format("YYYY-MM-DDTHH:mm:ss")+"Z",i=c(b.to).utc().format("YYYY-MM-DDTHH:mm:ss")+"Z";return a({method:"GET",url:"/admin/usage/usage-by-users/"+b.selectedAllocation.id+"/?from="+h+"&to="+i,cache:"true"}).then(function(a){d.removeLoading(e),g(b,a)},function(){d.addMessage(e,f,"danger"),d.removeLoading(e)})},e.getAllocationUserUsage=function(b){var c="allocationUsage"+b.id,e="There was an error loading user allocation usage.";return d.clearMessages(c),d.addLoading(c),a({method:"GET",url:"/admin/usage/allocation/"+b.selectedAllocation.id+"/username/"+b.selectedUser.username+"/",cache:"true"}).then(function(a){d.removeLoading(c),f(b,a)},function(){d.addMessage(c,e,"danger"),d.removeLoading(c)})},e.getAllocationUserQueueUsage=function(b){var c="allocationUsage"+b.id,e="There was an error loading user queue allocation usage.";return d.clearMessages(c),d.addLoading(c),a({method:"GET",url:"/admin/usage/allocation/"+b.selectedAllocation.id+"/username/"+b.selectedUser.username+"/queue/"+b.selectedQueue+"/",cache:"true"}).then(function(a){d.removeLoading(c),f(b,a)},function(){d.addMessage(c,e,"danger"),d.removeLoading(c)})},e.getAllocationQueueUsage=function(b){var c="allocationUsage"+b.id,e="There was an error loading queue allocation usage.";return d.clearMessages(c),d.addLoading(c),a({method:"GET",url:"/admin/usage/allocation/"+b.selectedAllocation.id+"/queue/"+b.selectedQueue+"/",cache:"true"}).then(function(a){d.removeLoading(c),f(b,a)},function(){d.addMessage(c,e,"danger"),d.removeLoading(c)})},e.getDailyUsage=function(f){var g="utilization",h="There was an error loading daily usage.";return a({method:"GET",url:"/admin/usage/daily-usage/",params:f,cache:"true"}).then(function(a){e.usage=a.data.result,e.usage=b.sortBy(e.usage,function(a){return c(a.date,"YYYY-MM-DD")}),console.log("factory.usage",e.usage)},function(){d.addMessage(g,h,"danger")})},e.getDowntimes=function(f){var g="utilization",h="There was an error loading downtimes.";return a({method:"GET",url:"/admin/usage/downtimes/",params:f,cache:"true"}).then(function(a){e.downtimes=a.data.result,e.downtimes=b.sortBy(e.downtimes,function(a){return c(a.date,"YYYY-MM-DD")}),console.log("factory.downtimes",e.downtimes)},function(){d.addMessage(g,h,"danger")})},e}]),angular.module("usageApp").controller("UsageController",["$scope","$http","$timeout","$q","$location","$filter","moment","highcharts","_","$modal","UtilFactory","AllocationFactory","NotificationFactory","UsageFactory",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){a.messages=[],a.$on("allocation:notifyMessage",function(){a.messages=m.getMessages()}),a.loading={},a.$on("allocation:notifyLoading",function(){a.loading=m.getLoading()}),a.close=k.closeMessage,a.isEmpty=k.isEmpty,a.hasMessage=k.hasMessage,a.isLoading=k.isLoading,a.getMessages=k.getMessages,a.getClass=k.getClass,a.filter={active:!0,inactive:!0,search:""},a.reset=function(){a.selectedProjects=a.projects,a.filter.active=!1,a.filter.inactive=!1,a.filter.search=""};var o={options:{chart:{zoomType:"x",type:"area"},rangeSelector:{enabled:!0,selected:2},navigator:{enabled:!0},colors:["#7cb5ec","#778b9e","#acf19d"],credits:{enabled:!1},plotOptions:{area:{dataLabels:{enabled:!0,color:h.theme&&h.theme.dataLabelsColor||"white",style:{textShadow:"0 0 3px black"}},fillOpacity:.5,marker:{enabled:!0,radius:3},shadow:!0,tooltip:{valueDecimals:2}},series:{lineWidth:1,dataLabels:{format:"{point.y:,.2f}"}}}},series:[],title:{text:""},useHighStocks:!0},p={options:{chart:{type:"column",alignTicks:!1},rangeSelector:{enabled:!0,selected:2},navigator:{enabled:!0},colors:["#7cb5ec","#778b9e","#acf19d"],credits:{enabled:!1},legend:{enabled:!0},plotOptions:{column:{stacking:"percent",dataLabels:{enabled:!0,color:Highcharts.theme&&Highcharts.theme.dataLabelsColor||"white",style:{textShadow:"0 0 3px black"}}}}},series:[],title:{text:"Chameleon Utilization"},useHighStocks:!0},q={options:{chart:{type:"column"},xAxis:{categories:[]},yAxis:{min:0,title:{text:"Total SUs Used"},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:h.theme&&h.theme.textColor||"gray"}}},legend:{align:"right",x:-30,verticalAlign:"top",y:25,floating:!0,backgroundColor:h.theme&&h.theme.background||"white",borderColor:"#CCC",borderWidth:1,shadow:!1},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0,color:h.theme&&h.theme.dataLabelsColor||"white",style:{textShadow:"0 0 3px black"}}}},tooltip:{formatter:function(){return"<b>"+this.x+"</b><br/>"+this.series.name+": "+this.y+"<br/>Total: "+this.point.stackTotal}},credits:{enabled:!1}},title:{text:""},series:[]},r=function(a){for(var b=0;b<a.length;b++){var c=a[b];if(c.hasActiveAllocation=!1,!i.isEmpty(c.allocations))for(var d=0;d<c.allocations.length;d++)c.allocations[d].hasUsage=!1,i.contains(["active","inactive"],c.allocations[d].status.toLowerCase())&&(c.hasActiveAllocation=!0,c.allocations[d].hasUsage=!0,c.selectedAllocation||(c.selectedAllocation=c.allocations[d]))}};a.getAllocations=function(){a.projects=[],l.getAllocations().then(function(){a.projects=l.projects,r(a.projects),a.updateSelected()})},a.utilization={from:null,to:null,startOpened:!1,endOpened:!1,selectedQueue:"",downtimes:[],usage:[],unused:[]};var s=function(){a.utilization.data=[];var b={};a.utilization.from&&(b.from=g(a.utilization.from).format("YYYY-MM-DD")),a.utilization.to&&(b.to=g(a.utilization.to).format("YYYY-MM-DD")),a.utilization.selectedQueue&&(b.queue=a.utilization.selectedQueue);var c=[];m.clearMessages("utilization"),m.addLoading("utilization"),c.push(n.getDowntimes(b)),c.push(n.getDailyUsage(b)),d.all(c).then(function(){m.removeLoading("utilization"),a.utilization.downtimes=n.downtimes,a.utilization.usage=n.usage,u()},function(){m.removeLoading("utilization")})};a.selections={usernamemodel:"",username:""},a.getUserAllocations=function(){a.projects=[],a.selections.username=a.selections.usernamemodel,e.url("/"+a.selections.username),a.submitted=!0,a.selections.username&&a.selections.username.length>0&&l.getUserAllocations(a.selections.username).then(function(){a.projects=l.userProjects,a.projects&&a.projects.length>0&&(r(a.projects),a.updateSelected())})},a.updateSelected=function(){a.selectedProjects=k.updateSelected(a.projects,a.selectedProjects,a.filter)},a.getAllocationsWithUsage=function(a){return i.filter(a.allocations,function(a){return a.hasUsage&&!a.doNotShow})};var t=function(a){a.usageChartConfig=angular.copy(o),a.usageChartConfig.title.text="Allocation Usage - "+a.selectedAllocation.resource+" ("+f("date")(a.selectedAllocation.start,"dd MMMM yyyy")+" - "+f("date")(a.selectedAllocation.end,"dd MMMM yyyy")+")",a.usageChartConfig.series=[],a.usageChartConfig.series.push({id:a.selectedAllocation.id,name:"SUs: ",data:a.selectedAllocation.usage,marker:{enabled:!0,radius:2},shadow:!0,tooltip:{valueDecimals:2}})},u=function(){a.utilization.usageChartConfig=angular.copy(p);var b=[];angular.forEach(a.utilization.downtimes,function(a){b.push([g(a.date,"YYYY-MM-DD").valueOf(),a.nodes_down])});var c=[];angular.forEach(a.utilization.usage,function(a){c.push([g(a.date,"YYYY-MM-DD").valueOf(),a.nodes_used])}),a.utilization.usageChartConfig.series.push({name:"Used",data:c},{name:"Downtime",data:b},{name:"Unused",data:[[g("2015/12/01","YYYY/MM/DD").valueOf(),110],[g("2015/12/02","YYYY/MM/DD").valueOf(),120],[g("2015/12/03","YYYY/MM/DD").valueOf(),130],[g("2015/12/04","YYYY/MM/DD").valueOf(),110]]})},v=function(a){a.selectedUser?a.selectedQueue?n.getAllocationUserQueueUsage(a).then(function(){t(a)}):n.getAllocationUserUsage(a).then(function(){t(a)}):a.selectedQueue?n.getAllocationQueueUsage(a).then(function(){t(a)}):n.getAllocationUsage(a).then(function(){t(a)})};a.viewUsage=function(a){a.showUPUChart=!1,a.showChart=!0,l.getProjectUsers(a),v(a)};var w=function(a){a.usageByUserChartConfig=angular.copy(q),a.usageByUserChartConfig.title.text=f("date")(a.from,"dd MMMM yyyy")+" - "+f("date")(a.to,"dd MMMM yyyy"),a.usageByUserChartConfig.series=[],a.usageByUserChartConfig.options.xAxis.categories=a.selectedAllocation.usageUsers;for(var b in a.selectedAllocation.usageByUsers)a.usageByUserChartConfig.series.push({name:b,data:a.selectedAllocation.usageByUsers[b]})},x=function(a){n.getUsageByUsers(a).then(function(){w(a)})},y=function(b){b.from=a.getMinDate(b),b.to=a.getMaxDate(b)},z=function(){a.utilization.from=a.getMinUtilizationDate(),a.utilization.to=a.getMaxUtilizationDate()};a.viewUsagePerUser=function(a){a.from&&a.to||(a.dateRange="all",y(a)),a.showChart=!1,a.showUPUChart=!0,x(a)},a.updateUsageByUsersChart=function(a,b){switch(b){case"1m":a.dateRange="1m",a.from=g().subtract(1,"months").format("YYYY-MM-DD"),a.to=g().format("YYYY-MM-DD");break;case"3m":a.dateRange="3m",a.from=g().subtract(3,"months").format("YYYY-MM-DD"),a.to=g().format("YYYY-MM-DD");break;case"6m":a.dateRange="6m",a.from=g().subtract(6,"months").format("YYYY-MM-DD"),a.to=g().format("YYYY-MM-DD");break;case"ytd":a.dateRange="ytd",a.from=g().startOf("year").format("YYYY-MM-DD"),a.to=g().format("YYYY-MM-DD");break;case"1y":a.dateRange="1y",a.from=g().subtract(1,"years").format("YYYY-MM-DD"),a.to=g().format("YYYY-MM-DD");break;case"all":a.dateRange="all",y(a);break;default:a.dateRange="custom",a.from=g(a.from).format("YYYY-MM-DD"),a.to=g(a.to).format("YYYY-MM-DD")}x(a)},a.updateUtilizationChart=function(b){switch(b){case"1m":a.utilization.dateRange="1m",a.utilization.from=g().subtract(1,"months").format("YYYY-MM-DD"),a.utilization.to=g().startOf("day").format("YYYY-MM-DD");break;case"3m":a.utilization.dateRange="3m",a.utilization.from=g().subtract(3,"months").format("YYYY-MM-DD"),a.utilization.to=g().format("YYYY-MM-DD");break;case"6m":a.utilization.dateRange="6m",a.utilization.from=g().subtract(6,"months").format("YYYY-MM-DD"),a.utilization.to=g().format("YYYY-MM-DD");break;case"ytd":a.utilization.dateRange="ytd",a.utilization.from=g().startOf("year").format("YYYY-MM-DD"),a.utilization.to=g().format("YYYY-MM-DD");break;case"1y":a.utilization.dateRange="1y",a.utilization.from=g().subtract(1,"years").format("YYYY-MM-DD"),a.utilization.to=g().format("YYYY-MM-DD");break;case"all":a.utilization.dateRange="all",z();break;default:a.utilization.dateRange="custom",a.utilization.from=g(a.utilization.from).format("YYYY-MM-DD"),a.utilization.to=g(a.utilization.to).format("YYYY-MM-DD")}s()},a.viewUserUsage=function(b){b.showChart=!0,b.selectedUser={username:a.selections.username},v(b)},a.updateChart=function(a){v(a)},a.submitted=!1,a.handleKeyPress=function(b){var c=b.keyCode||b.which;13===c&&a.getUserAllocations()},a.dateOptions={formatYear:"yy",startingDay:1},a.format="dd MMMM yyyy",a.disabled=function(a,b){return!1},a.getMaxDate=function(a){var b=g().format("YYYY-MM-DD");return g(a.selectedAllocation.end).isAfter(b,"day")?b:g(a.selectedAllocation.end).format("YYYY-MM-DD")},a.getMinDate=function(a){return g(a.selectedAllocation.start).format("YYYY-MM-DD")},a.getMaxUtilizationDate=function(){return g().format("YYYY-MM-DD")},a.getMinUtilizationDate=function(){return"01-01-2014"},a.open={},a.isOpen=function(a,b,c){a.preventDefault(),a.stopPropagation(),"start"===c?(b.endOpened=!1,b.startOpened=!0):"end"===c&&(b.startOpened=!1,b.endOpened=!0)},a.isOpen4Utilization=function(b,c){b.preventDefault(),b.stopPropagation(),"start"===c?(a.utilization.endOpened=!1,a.utilization.startOpened=!0):"end"===c&&(a.utilization.endOpened=!0,a.utilization.startOpened=!1)};var A=e.path();A?(a.selections.usernamemodel=A.substring(1),a.getUserAllocations()):-1!==e.absUrl().indexOf("utilization")?(z(),s()):a.getAllocations()}]);