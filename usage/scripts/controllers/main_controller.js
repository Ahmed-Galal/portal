/**
 * author agauli
 */
'use strict';
/* global Highcharts */
angular.module('usageApp')
    .controller('UsageController', ['$scope', '$http', '$timeout', '$location', '$filter', 'moment',
        '_', '$modal', 'UtilFactory', 'AllocationFactory', 'NotificationFactory', 'UsageFactory',
        function($scope, $http, $timeout, $location, $filter, moment, _, $modal, UtilFactory,
            AllocationFactory, NotificationFactory, UsageFactory) {
            $scope.messages = [];
            $scope.$on('allocation:notifyMessage', function() {
                $scope.messages = NotificationFactory.getMessages();
            });
            $scope.loading = {};
            $scope.$on('allocation:notifyLoading', function() {
                $scope.loading = NotificationFactory.getLoading();
            });
            $scope.close = UtilFactory.closeMessage;
            $scope.isEmpty = UtilFactory.isEmpty;
            $scope.hasMessage = UtilFactory.hasMessage;
            $scope.isLoading = UtilFactory.isLoading;
            $scope.getMessages = UtilFactory.getMessages;
            $scope.getClass = UtilFactory.getClass;

            $scope.filter = {
                active: true,
                inactive: true,
                search: ''
            };

            $scope.reset = function() {
                $scope.selectedProjects = $scope.projects;
                $scope.filter.active = false;
                $scope.filter.inactive = false;
                $scope.filter.search = '';
            };

            var usageChartConfig = {
                options: {
                    chart: {
                        zoomType: 'x'
                    },
                    rangeSelector: {
                        enabled: true,
                        selected: 2
                    },
                    navigator: {
                        enabled: true
                    },
                    colors: ['#7cb5ec'],
                    credits: {
                        enabled: false
                    },
                },
                series: [],
                title: {
                    text: ''
                },
                useHighStocks: true
            };

            var usageByUserChartConfig = {
                options: {
                    chart: {
                        type: 'column'
                    },
                    xAxis: {
                        categories: []
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: 'Total SUs Used'
                        },
                        stackLabels: {
                            enabled: true,
                            style: {
                                fontWeight: 'bold',
                                color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
                            }
                        }
                    },
                    legend: {
                        align: 'right',
                        x: -30,
                        verticalAlign: 'top',
                        y: 25,
                        floating: true,
                        backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
                        borderColor: '#CCC',
                        borderWidth: 1,
                        shadow: false
                    },
                    plotOptions: {
                        column: {
                            stacking: 'normal',
                            dataLabels: {
                                enabled: true,
                                color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white',
                                style: {
                                    textShadow: '0 0 3px black'
                                }
                            }
                        }
                    },
                    tooltip: {
                        formatter: function() {
                            return '<b>' + this.x + '</b><br/>' +
                                this.series.name + ': ' + this.y + '<br/>' +
                                'Total: ' + this.point.stackTotal;
                        }
                    },
                    credits: {
                        enabled: false
                    },
                },
                title: {
                    text: ''
                },
                series: []
            };

            var processAllocations = function(projects) {
                for (var i = 0; i < projects.length; i++) {
                    var project = projects[i];
                    project.hasActiveAllocation = false;
                    if (!_.isEmpty(project.allocations)) {
                        for (var j = 0; j < project.allocations.length; j++) {
                            project.allocations[j].hasUsage = false;
                            if (_.contains(['active', 'inactive'], project.allocations[j].status.toLowerCase())) {
                                project.hasActiveAllocation = true;
                                project.allocations[j].hasUsage = true;
                                if (!project.selectedAllocation) {
                                    project.selectedAllocation = project.allocations[j];
                                }
                            }
                        }
                    }
                }
            };

            $scope.getAllocations = function() {
                $scope.projects = [];
                AllocationFactory.getAllocations().then(function() {
                    $scope.projects = AllocationFactory.projects;
                    processAllocations($scope.projects);
                    $scope.updateSelected();
                });
            };

            $scope.getUserAllocations = function() {
                $scope.projects = [];
                $scope.selections.username = $scope.selections.usernamemodel;
                $location.url('/' + $scope.selections.username);
                $scope.submitted = true;
                if ($scope.selections.username && $scope.selections.username.length > 0) {
                    AllocationFactory.getUserAllocations($scope.selections.username).then(function() {
                        $scope.projects = AllocationFactory.userProjects;
                        processAllocations($scope.projects);
                        $scope.updateSelected();
                    });
                }
            };

            $scope.updateSelected = function() {
                $scope.selectedProjects = UtilFactory.updateSelected($scope.projects, $scope.selectedProjects, $scope.filter);
            };


            $scope.getAllocationsWithUsage = function(project) {
                return _.filter(project.allocations, function(allocation) {
                    return allocation.hasUsage && !allocation.doNotShow;
                });

            };

            var drawUsageChart = function(project) {
                project.usageChartConfig = angular.copy(usageChartConfig);
                project.usageChartConfig.title.text = 'Allocation Usage - ' +
                    project.selectedAllocation.resource + ' (' + $filter('date')(project.selectedAllocation.start, 'dd MMMM yyyy') +
                    ' - ' + $filter('date')(project.selectedAllocation.end, 'dd MMMM yyyy') + ')';
                project.usageChartConfig.series = [];
                project.usageChartConfig.series.push({
                    id: project.selectedAllocation.id,
                    name: 'SUs: ',
                    data: project.selectedAllocation.usage,
                    // data: [
                    //     /* Jan 2013 */
                    //     [1357084800000, 78.43],
                    //     [1357171200000, 77.44],
                    //     [1357257600000, 75.29],
                    //     [1357516800000, 74.80],
                    //     [1357603200000, 75.04],
                    //     [1357689600000, 73.87],
                    //     [1357776000000, 74.79],
                    //     [1357862400000, 74.33],
                    //     [1358121600000, 71.68],
                    //     [1358208000000, 69.42],
                    //     [1358294400000, 72.30],
                    //     [1358380800000, 71.81],
                    //     [1358467200000, 71.43],
                    //     [1358812800000, 72.11],
                    //     [1358899200000, 73.43],
                    //     [1358985600000, 64.36],
                    //     [1359072000000, 62.84],
                    //     [1359331200000, 64.26],
                    //     [1359417600000, 65.47],
                    //     [1359504000000, 65.26],
                    //     [1359590400000, 65.07],
                    //     /* Feb 2013 */
                    //     [1359676800000, 64.80],
                    //     [1359936000000, 63.19],
                    //     [1360022400000, 65.41],
                    //     [1360108800000, 65.34],
                    //     [1360195200000, 66.89],
                    //     [1360281600000, 67.85],
                    //     [1360540800000, 68.56],
                    //     [1360627200000, 66.84],
                    //     [1360713600000, 66.72],
                    //     [1360800000000, 66.66],
                    //     [1360886400000, 65.74],
                    //     [1361232000000, 65.71],
                    //     [1361318400000, 64.12],
                    //     [1361404800000, 63.72],
                    //     [1361491200000, 64.40],
                    //     [1361750400000, 63.26],
                    //     [1361836800000, 64.14],
                    //     [1361923200000, 63.51],
                    //     [1362009600000, 63.06],
                    //     /* Mar 2013 */
                    //     [1362096000000, 61.50],
                    //     [1362355200000, 60.01],
                    //     [1362441600000, 61.59],
                    //     [1362528000000, 60.81],
                    //     [1362614400000, 61.51],
                    //     [1362700800000, 61.67],
                    //     [1362960000000, 62.55],
                    //     [1363046400000, 61.20],
                    //     [1363132800000, 61.19],
                    //     [1363219200000, 61.79],
                    //     [1363305600000, 63.38],
                    //     [1363564800000, 65.10],
                    //     [1363651200000, 64.93],
                    //     [1363737600000, 64.58],
                    //     [1363824000000, 64.68],
                    //     [1363910400000, 65.99],
                    //     [1364169600000, 66.23],
                    //     [1364256000000, 65.88],
                    //     [1364342400000, 64.58],
                    //     [1364428800000, 63.24],
                    //     /* Apr 2013 */
                    //     [1364774400000, 61.27],
                    //     [1364860800000, 61.40],
                    //     [1364947200000, 61.71],
                    //     [1365033600000, 61.10],
                    //     [1365120000000, 60.46],
                    //     [1365379200000, 60.89],
                    //     [1365465600000, 61.00],
                    //     [1365552000000, 62.24],
                    //     [1365638400000, 62.05],
                    //     [1365724800000, 61.40],
                    //     [1365984000000, 59.98],
                    //     [1366070400000, 60.89],
                    //     [1366156800000, 57.54],
                    //     [1366243200000, 56.01],
                    //     [1366329600000, 55.79],
                    //     [1366588800000, 56.95],
                    //     [1366675200000, 58.02],
                    //     [1366761600000, 57.92],
                    //     [1366848000000, 58.34],
                    //     [1366934400000, 59.60],
                    //     [1367193600000, 61.45],
                    //     [1367280000000, 63.25],
                    //     /* May 2013 */
                    //     [1367366400000, 62.76],
                    //     [1367452800000, 63.65],
                    //     [1367539200000, 64.28],
                    //     [1367798400000, 65.82],
                    //     [1367884800000, 65.52],
                    //     [1367971200000, 66.26],
                    //     [1368057600000, 65.25],
                    //     [1368144000000, 64.71],
                    //     [1368403200000, 64.96],
                    //     [1368489600000, 63.41],
                    //     [1368576000000, 61.26],
                    //     [1368662400000, 62.08],
                    //     [1368748800000, 61.89],
                    //     [1369008000000, 63.28],
                    //     [1369094400000, 62.81],
                    //     [1369180800000, 63.05],
                    //     [1369267200000, 63.16],
                    //     [1369353600000, 63.59],
                    //     [1369699200000, 63.06],
                    //     [1369785600000, 63.56],
                    //     [1369872000000, 64.51],
                    //     [1369958400000, 64.25],
                    //     /* Jun 2013 */
                    //     [1370217600000, 64.39],
                    //     [1370304000000, 64.19],
                    //     [1370390400000, 63.59],
                    //     [1370476800000, 62.64],
                    //     [1370563200000, 63.12],
                    //     [1370822400000, 62.70],
                    //     [1370908800000, 62.51],
                    //     [1370995200000, 61.74],
                    //     [1371081600000, 62.28],
                    //     [1371168000000, 61.44],
                    //     [1371427200000, 61.71],
                    //     [1371513600000, 61.68],
                    //     [1371600000000, 60.43],
                    //     [1371686400000, 59.55],
                    //     [1371772800000, 59.07],
                    //     [1372032000000, 57.51],
                    //     [1372118400000, 57.52],
                    //     [1372204800000, 56.87],
                    //     [1372291200000, 56.25],
                    //     [1372377600000, 56.65],
                    //     /* Jul 2013 */
                    //     [1372636800000, 58.46],
                    //     [1372723200000, 59.78],
                    //     [1372809600000, 60.11],
                    //     [1372982400000, 59.63],
                    //     [1373241600000, 59.29],
                    //     [1373328000000, 60.34],
                    //     [1373414400000, 60.10],
                    //     [1373500800000, 61.04],
                    //     [1373587200000, 60.93],
                    //     [1373846400000, 61.06],
                    //     [1373932800000, 61.46],
                    //     [1374019200000, 61.47],
                    //     [1374105600000, 61.68],
                    //     [1374192000000, 60.71],
                    //     [1374451200000, 60.90],
                    //     [1374537600000, 59.86],
                    //     [1374624000000, 62.93],
                    //     [1374710400000, 62.64],
                    //     [1374796800000, 63.00],
                    //     [1375056000000, 63.97],
                    //     [1375142400000, 64.76],
                    //     [1375228800000, 64.65],
                    //     /* Aug 2013 */
                    //     [1375315200000, 65.24],
                    //     [1375401600000, 66.08],
                    //     [1375660800000, 67.06],
                    //     [1375747200000, 66.46],
                    //     [1375833600000, 66.43],
                    //     [1375920000000, 65.86],
                    //     [1376006400000, 64.92],
                    //     [1376265600000, 66.77],
                    //     [1376352000000, 69.94],
                    //     [1376438400000, 71.21],
                    //     [1376524800000, 71.13],
                    //     [1376611200000, 71.76],
                    //     [1376870400000, 72.53],
                    //     [1376956800000, 71.58],
                    //     [1377043200000, 71.77],
                    //     [1377129600000, 71.85],
                    //     [1377216000000, 71.57],
                    //     [1377475200000, 71.85],
                    //     [1377561600000, 69.80],
                    //     [1377648000000, 70.13],
                    //     [1377734400000, 70.24],
                    //     [1377820800000, 69.60],
                    //     /* Sep 2013 */
                    //     [1378166400000, 69.80],
                    //     [1378252800000, 71.24],
                    //     [1378339200000, 70.75],
                    //     [1378425600000, 71.17],
                    //     [1378684800000, 72.31],
                    //     [1378771200000, 70.66],
                    //     [1378857600000, 66.82],
                    //     [1378944000000, 67.53],
                    //     [1379030400000, 66.41],
                    //     [1379289600000, 64.30],
                    //     [1379376000000, 65.05],
                    //     [1379462400000, 66.38],
                    //     [1379548800000, 67.47],
                    //     [1379635200000, 66.77],
                    //     [1379894400000, 70.09],
                    //     [1379980800000, 69.87],
                    //     [1380067200000, 68.79],
                    //     [1380153600000, 69.46],
                    //     [1380240000000, 68.96],
                    //     [1380499200000, 68.11],
                    //     /* Oct 2013 */
                    //     [1380585600000, 69.71],
                    //     [1380672000000, 69.94],
                    //     [1380758400000, 69.06],
                    //     [1380844800000, 69.00],
                    //     [1381104000000, 69.68],
                    //     [1381190400000, 68.71],
                    //     [1381276800000, 69.51],
                    //     [1381363200000, 69.95],
                    //     [1381449600000, 70.40],
                    //     [1381708800000, 70.86],
                    //     [1381795200000, 71.24],
                    //     [1381881600000, 71.59],
                    //     [1381968000000, 72.07],
                    //     [1382054400000, 72.70],
                    //     [1382313600000, 74.48],
                    //     [1382400000000, 74.27],
                    //     [1382486400000, 74.99],
                    //     [1382572800000, 75.99],
                    //     [1382659200000, 75.14],
                    //     [1382918400000, 75.70],
                    //     [1383004800000, 73.81],
                    //     [1383091200000, 74.98],
                    //     [1383177600000, 74.67],
                    //     /* Nov 2013 */
                    //     [1383264000000, 74.29],
                    //     [1383523200000, 75.25],
                    //     [1383609600000, 75.06],
                    //     [1383696000000, 74.42],
                    //     [1383782400000, 73.21],
                    //     [1383868800000, 74.37],
                    //     [1384128000000, 74.15],
                    //     [1384214400000, 74.29],
                    //     [1384300800000, 74.38],
                    //     [1384387200000, 75.45],
                    //     [1384473600000, 75.00],
                    //     [1384732800000, 74.09],
                    //     [1384819200000, 74.22],
                    //     [1384905600000, 73.57],
                    //     [1384992000000, 74.45],
                    //     [1385078400000, 74.26],
                    //     [1385337600000, 74.82],
                    //     [1385424000000, 76.20],
                    //     [1385510400000, 77.99],
                    //     [1385683200000, 79.44],
                    //     /* Dec 2013 */
                    //     [1385942400000, 78.75],
                    //     [1386028800000, 80.90],
                    //     [1386115200000, 80.71],
                    //     [1386201600000, 81.13],
                    //     [1386288000000, 80.00],
                    //     [1386547200000, 80.92],
                    //     [1386633600000, 80.79],
                    //     [1386720000000, 80.19],
                    //     [1386806400000, 80.08],
                    //     [1386892800000, 79.20],
                    //     [1387152000000, 79.64],
                    //     [1387238400000, 79.28],
                    //     [1387324800000, 78.68],
                    //     [1387411200000, 77.78],
                    //     [1387497600000, 78.43],
                    //     [1387756800000, 81.44],
                    //     [1387843200000, 81.10],
                    //     [1388016000000, 80.56],
                    //     [1388102400000, 80.01],
                    //     [1388361600000, 79.22],
                    //     [1388448000000, 80.15],
                    //     /* Jan 2014 */
                    //     [1388620800000, 79.02],
                    //     [1388707200000, 77.28],
                    //     [1388966400000, 77.70],
                    //     [1389052800000, 77.15],
                    //     [1389139200000, 77.64],
                    //     [1389225600000, 76.65],
                    //     [1389312000000, 76.13],
                    //     [1389571200000, 76.53],
                    //     [1389657600000, 78.06],
                    //     [1389744000000, 79.62],
                    //     [1389830400000, 79.18],
                    //     [1389916800000, 77.24],
                    //     [1390262400000, 78.44],
                    //     [1390348800000, 78.79],
                    //     [1390435200000, 79.45],
                    //     [1390521600000, 78.01],
                    //     [1390780800000, 78.64],
                    //     [1390867200000, 72.36],
                    //     [1390953600000, 71.54],
                    //     [1391040000000, 71.40],
                    //     [1391126400000, 71.51],
                    //     /* Feb 2014 */
                    //     [1391385600000, 71.65],
                    //     [1391472000000, 72.68],
                    //     [1391558400000, 73.23],
                    //     [1391644800000, 73.22],
                    //     [1391731200000, 74.24],
                    //     [1391990400000, 75.57],
                    //     [1392076800000, 76.57],
                    //     [1392163200000, 76.56],
                    //     [1392249600000, 77.78],
                    //     [1392336000000, 77.71],
                    //     [1392681600000, 78.00],
                    //     [1392768000000, 76.77],
                    //     [1392854400000, 75.88],
                    //     [1392940800000, 75.04],
                    //     [1393200000000, 75.36],
                    //     [1393286400000, 74.58],
                    //     [1393372800000, 73.91],
                    //     [1393459200000, 75.38],
                    //     [1393545600000, 75.18],
                    //     /* Mar 2014 */
                    //     [1393804800000, 75.39],
                    //     [1393891200000, 75.89],
                    //     [1393977600000, 76.05],
                    //     [1394064000000, 75.82],
                    //     [1394150400000, 75.78],
                    //     [1394409600000, 75.85],
                    //     [1394496000000, 76.58],
                    //     [1394582400000, 76.66],
                    //     [1394668800000, 75.81],
                    //     [1394755200000, 74.96],
                    //     [1395014400000, 75.25],
                    //     [1395100800000, 75.91],
                    //     [1395187200000, 75.89],
                    //     [1395273600000, 75.53],
                    //     [1395360000000, 76.12],
                    //     [1395619200000, 77.03],
                    //     [1395705600000, 77.86],
                    //     [1395792000000, 77.11],
                    //     [1395878400000, 76.78],
                    //     [1395964800000, 76.69],
                    //     [1396224000000, 76.68],
                    //     /* Apr 2014 */
                    //     [1396310400000, 77.38],
                    //     [1396396800000, 77.51],
                    //     [1396483200000, 76.97],
                    //     [1396569600000, 75.97],
                    //     [1396828800000, 74.78],
                    //     [1396915200000, 74.78],
                    //     [1397001600000, 75.76],
                    //     [1397088000000, 74.78],
                    //     [1397174400000, 74.23],
                    //     [1397433600000, 74.53],
                    //     [1397520000000, 73.99],
                    //     [1397606400000, 74.14],
                    //     [1397692800000, 74.99],
                    //     [1398038400000, 75.88],
                    //     [1398124800000, 75.96],
                    //     [1398211200000, 74.96],
                    //     [1398297600000, 81.11],
                    //     [1398384000000, 81.71],
                    //     [1398643200000, 84.87],
                    //     [1398729600000, 84.62],
                    //     [1398816000000, 84.30],
                    //     /* May 2014 */
                    //     [1398902400000, 84.50],
                    //     [1398988800000, 84.65],
                    //     [1399248000000, 85.85],
                    //     [1399334400000, 84.92],
                    //     [1399420800000, 84.62],
                    //     [1399507200000, 84.00],
                    //     [1399593600000, 83.65],
                    //     [1399852800000, 84.69],
                    //     [1399939200000, 84.82],
                    //     [1400025600000, 84.84],
                    //     [1400112000000, 84.12],
                    //     [1400198400000, 85.36],
                    //     [1400457600000, 86.37],
                    //     [1400544000000, 86.39],
                    //     [1400630400000, 86.62],
                    //     [1400716800000, 86.75],
                    //     [1400803200000, 87.73],
                    //     [1401148800000, 89.38],
                    //     [1401235200000, 89.14],
                    //     [1401321600000, 90.77],
                    //     [1401408000000, 90.43],
                    //     /* Jun 2014 */
                    //     [1401667200000, 89.81],
                    //     [1401753600000, 91.08],
                    //     [1401840000000, 92.12],
                    //     [1401926400000, 92.48],
                    //     [1402012800000, 92.22],
                    //     [1402272000000, 93.70],
                    //     [1402358400000, 94.25],
                    //     [1402444800000, 93.86],
                    //     [1402531200000, 92.29],
                    //     [1402617600000, 91.28],
                    //     [1402876800000, 92.20],
                    //     [1402963200000, 92.08],
                    //     [1403049600000, 92.18],
                    //     [1403136000000, 91.86],
                    //     [1403222400000, 90.91],
                    //     [1403481600000, 90.83],
                    //     [1403568000000, 90.28],
                    //     [1403654400000, 90.36],
                    //     [1403740800000, 90.90],
                    //     [1403827200000, 91.98],
                    //     [1404086400000, 92.93],
                    //     /* Jul 2014 */
                    //     [1404172800000, 93.52],
                    //     [1404259200000, 93.48],
                    //     [1404345600000, 94.03],
                    //     [1404691200000, 95.97],
                    //     [1404777600000, 95.35],
                    //     [1404864000000, 95.39],
                    //     [1404950400000, 95.04],
                    //     [1405036800000, 95.22],
                    //     [1405296000000, 96.45],
                    //     [1405382400000, 95.32],
                    //     [1405468800000, 94.78],
                    //     [1405555200000, 93.09],
                    //     [1405641600000, 94.43],
                    //     [1405900800000, 93.94],
                    //     [1405987200000, 94.72],
                    //     [1406073600000, 97.19],
                    //     [1406160000000, 97.03],
                    //     [1406246400000, 97.67],
                    //     [1406505600000, 99.02],
                    //     [1406592000000, 98.38],
                    //     [1406678400000, 98.15],
                    //     [1406764800000, 95.60],
                    //     /* Aug 2014 */
                    //     [1406851200000, 96.13],
                    //     [1407110400000, 95.59],
                    //     [1407196800000, 95.12],
                    //     [1407283200000, 94.96],
                    //     [1407369600000, 94.48],
                    //     [1407456000000, 94.74],
                    //     [1407715200000, 95.99],
                    //     [1407801600000, 95.97],
                    //     [1407888000000, 97.24],
                    //     [1407974400000, 97.50],
                    //     [1408060800000, 97.98],
                    //     [1408320000000, 99.16],
                    //     [1408406400000, 100.53],
                    //     [1408492800000, 100.57],
                    //     [1408579200000, 100.58],
                    //     [1408665600000, 101.32],
                    //     [1408924800000, 101.54],
                    //     [1409011200000, 100.89],
                    //     [1409097600000, 102.13],
                    //     [1409184000000, 102.25],
                    //     [1409270400000, 102.50],
                    //     /* Sep 2014 */
                    //     [1409616000000, 103.30],
                    //     [1409702400000, 98.94],
                    //     [1409788800000, 98.12],
                    //     [1409875200000, 98.97],
                    //     [1410134400000, 98.36],
                    //     [1410220800000, 97.99],
                    //     [1410307200000, 101.00],
                    //     [1410393600000, 101.43],
                    //     [1410480000000, 101.66],
                    //     [1410739200000, 101.63],
                    //     [1410825600000, 100.86],
                    //     [1410912000000, 101.58],
                    //     [1410998400000, 101.79],
                    //     [1411084800000, 100.96],
                    //     [1411344000000, 101.06],
                    //     [1411430400000, 102.64],
                    //     [1411516800000, 101.75],
                    //     [1411603200000, 97.87],
                    //     [1411689600000, 100.75],
                    //     [1411948800000, 100.11],
                    //     [1412035200000, 100.75],
                    //     /* Oct 2014 */
                    //     [1412121600000, 99.18],
                    //     [1412208000000, 99.90],
                    //     [1412294400000, 99.62],
                    //     [1412553600000, 99.62],
                    //     [1412640000000, 98.75],
                    //     [1412726400000, 100.80],
                    //     [1412812800000, 101.02],
                    //     [1412899200000, 100.73],
                    //     [1413158400000, 99.81],
                    //     [1413244800000, 98.75],
                    //     [1413331200000, 97.54],
                    //     [1413417600000, 96.26],
                    //     [1413504000000, 97.67],
                    //     [1413763200000, 99.76],
                    //     [1413849600000, 102.47],
                    //     [1413936000000, 102.99],
                    //     [1414022400000, 104.83],
                    //     [1414108800000, 105.22],
                    //     [1414368000000, 105.11],
                    //     [1414454400000, 106.74],
                    //     [1414540800000, 107.34],
                    //     [1414627200000, 106.98],
                    //     [1414713600000, 108.00],
                    //     /* Nov 2014 */
                    //     [1414972800000, 109.40],
                    //     [1415059200000, 108.60],
                    //     [1415145600000, 108.86],
                    //     [1415232000000, 108.70],
                    //     [1415318400000, 109.01],
                    //     [1415577600000, 108.83],
                    //     [1415664000000, 109.70],
                    //     [1415750400000, 111.25],
                    //     [1415836800000, 112.82],
                    //     [1415923200000, 114.18],
                    //     [1416182400000, 113.99],
                    //     [1416268800000, 115.47],
                    //     [1416355200000, 114.67],
                    //     [1416441600000, 116.31],
                    //     [1416528000000, 116.47],
                    //     [1416787200000, 118.62],
                    //     [1416873600000, 117.60],
                    //     [1416960000000, 119.00],
                    //     [1417132800000, 118.93],
                    //     /* Dec 2014 */
                    //     [1417392000000, 115.07],
                    //     [1417478400000, 114.63],
                    //     [1417564800000, 115.93],
                    //     [1417651200000, 115.49],
                    //     [1417737600000, 115.00],
                    //     [1417996800000, 112.40],
                    //     [1418083200000, 114.12],
                    //     [1418169600000, 111.95],
                    //     [1418256000000, 111.62],
                    //     [1418342400000, 109.73],
                    //     [1418601600000, 108.22],
                    //     [1418688000000, 106.74],
                    //     [1418774400000, 109.41],
                    //     [1418860800000, 112.65],
                    //     [1418947200000, 111.78],
                    //     [1419206400000, 112.94],
                    //     [1419292800000, 112.54],
                    //     [1419379200000, 112.01],
                    //     [1419552000000, 113.99],
                    //     [1419811200000, 113.91],
                    //     [1419897600000, 112.52],
                    //     [1419984000000, 110.38],
                    //     /* Jan 2015 */
                    //     [1420156800000, 109.33],
                    //     [1420416000000, 106.25],
                    //     [1420502400000, 106.26],
                    //     [1420588800000, 107.75],
                    //     [1420675200000, 111.89],
                    //     [1420761600000, 112.01],
                    //     [1421020800000, 109.25],
                    //     [1421107200000, 110.22],
                    //     [1421193600000, 109.80],
                    //     [1421280000000, 106.82],
                    //     [1421366400000, 105.99],
                    //     [1421712000000, 108.72],
                    //     [1421798400000, 109.55],
                    //     [1421884800000, 112.40],
                    //     [1421971200000, 112.98],
                    //     [1422230400000, 113.10],
                    //     [1422316800000, 109.14],
                    //     [1422403200000, 115.31],
                    //     [1422489600000, 118.90],
                    //     [1422576000000, 117.16],
                    //     /* Feb 2015 */
                    //     [1422835200000, 118.63],
                    //     [1422921600000, 118.65],
                    //     [1423008000000, 119.56],
                    //     [1423094400000, 119.94],
                    //     [1423180800000, 118.93],
                    //     [1423440000000, 119.72],
                    //     [1423526400000, 122.02],
                    //     [1423612800000, 124.88],
                    //     [1423699200000, 126.46],
                    //     [1423785600000, 127.08],
                    //     [1424131200000, 127.83],
                    //     [1424217600000, 128.72],
                    //     [1424304000000, 128.45],
                    //     [1424390400000, 129.50],
                    //     [1424649600000, 133.00],
                    //     [1424736000000, 132.17],
                    //     [1424822400000, 128.79],
                    //     [1424908800000, 130.42],
                    //     [1424995200000, 128.46],
                    //     /* Mar 2015 */
                    //     [1425254400000, 129.09],
                    //     [1425340800000, 129.36],
                    //     [1425427200000, 128.54],
                    //     [1425513600000, 126.41],
                    //     [1425600000000, 126.60],
                    //     [1425859200000, 127.14],
                    //     [1425945600000, 124.51],
                    //     [1426032000000, 122.24],
                    //     [1426118400000, 124.45],
                    //     [1426204800000, 123.59],
                    //     [1426464000000, 124.95],
                    //     [1426550400000, 127.04],
                    //     [1426636800000, 128.47],
                    //     [1426723200000, 127.50],
                    //     [1426809600000, 125.90],
                    //     [1427068800000, 127.21],
                    //     [1427155200000, 126.69],
                    //     [1427241600000, 123.38],
                    //     [1427328000000, 124.24],
                    //     [1427414400000, 123.25],
                    //     [1427673600000, 126.37],
                    //     [1427760000000, 124.43],
                    //     /* Apr 2015 */
                    //     [1427846400000, 124.25],
                    //     [1427932800000, 125.32],
                    //     [1428278400000, 127.35],
                    //     [1428364800000, 126.01],
                    //     [1428451200000, 125.60],
                    //     [1428537600000, 126.56],
                    //     [1428624000000, 127.10],
                    //     [1428883200000, 126.85],
                    //     [1428969600000, 126.30],
                    //     [1429056000000, 126.78],
                    //     [1429142400000, 126.17],
                    //     [1429228800000, 124.75],
                    //     [1429488000000, 127.60],
                    //     [1429574400000, 126.91],
                    //     [1429660800000, 128.62],
                    //     [1429747200000, 129.67],
                    //     [1429833600000, 130.28],
                    //     [1430092800000, 132.65],
                    //     [1430179200000, 130.56],
                    //     [1430265600000, 128.64],
                    //     [1430352000000, 125.15],
                    //     /* May 2015 */
                    //     [1430438400000, 128.95],
                    //     [1430697600000, 128.70],
                    //     [1430784000000, 125.80],
                    //     [1430870400000, 125.01],
                    //     [1430956800000, 125.26],
                    //     [1431043200000, 127.62],
                    //     [1431302400000, 126.32],
                    //     [1431388800000, 125.86],
                    //     [1431475200000, 126.01],
                    //     [1431561600000, 128.95],
                    //     [1431648000000, 128.77],
                    //     [1431907200000, 130.19],
                    //     [1431993600000, 130.07],
                    //     [1432080000000, 130.06],
                    //     [1432166400000, 131.39],
                    //     [1432252800000, 132.54],
                    //     [1432598400000, 129.62],
                    //     [1432684800000, 132.04],
                    //     [1432771200000, 131.78],
                    //     [1432857600000, 130.28],
                    //     /* Jun 2015 */
                    //     [1433116800000, 130.54],
                    //     [1433203200000, 129.96],
                    //     [1433289600000, 130.12],
                    //     [1433376000000, 129.36],
                    //     [1433462400000, 128.65],
                    //     [1433721600000, 127.80],
                    //     [1433808000000, 127.42],
                    //     [1433894400000, 128.88],
                    //     [1433980800000, 128.59],
                    //     [1434067200000, 127.17],
                    //     [1434326400000, 126.92],
                    //     [1434412800000, 127.60],
                    //     [1434499200000, 127.30],
                    //     [1434585600000, 127.88],
                    //     [1434672000000, 126.60],
                    //     [1434931200000, 127.61],
                    //     [1435017600000, 127.03],
                    //     [1435104000000, 128.11],
                    //     [1435190400000, 127.50],
                    //     [1435276800000, 126.75],
                    //     [1435536000000, 124.53],
                    //     [1435622400000, 125.42],
                    //     /* Jul 2015 */
                    //     [1435708800000, 126.60],
                    //     [1435795200000, 126.44],
                    //     [1436140800000, 126.00],
                    //     [1436227200000, 125.69],
                    //     [1436313600000, 122.57],
                    //     [1436400000000, 120.07],
                    //     [1436486400000, 123.28],
                    //     [1436745600000, 125.66],
                    //     [1436832000000, 125.61],
                    //     [1436918400000, 126.82],
                    //     [1437004800000, 128.51],
                    //     [1437091200000, 129.62],
                    //     [1437350400000, 132.07],
                    //     [1437436800000, 130.75],
                    //     [1437523200000, 125.22],
                    //     [1437609600000, 125.16],
                    //     [1437696000000, 124.50],
                    //     [1437955200000, 122.77],
                    //     [1438041600000, 123.38],
                    //     [1438128000000, 122.99],
                    //     [1438214400000, 122.37],
                    //     [1438300800000, 121.30],
                    //     /* Aug 2015 */
                    //     [1438560000000, 118.44],
                    //     [1438646400000, 114.64],
                    //     [1438732800000, 115.40],
                    //     [1438819200000, 115.13],
                    //     [1438905600000, 115.52],
                    //     [1439164800000, 119.72],
                    //     [1439251200000, 113.49],
                    //     [1439337600000, 115.24],
                    //     [1439424000000, 115.15],
                    //     [1439510400000, 115.96],
                    //     [1439769600000, 117.16],
                    //     [1439856000000, 116.50],
                    //     [1439942400000, 115.01],
                    //     [1440028800000, 112.65],
                    //     [1440115200000, 105.76],
                    //     [1440374400000, 103.12],
                    //     [1440460800000, 103.74],
                    //     [1440547200000, 109.69],
                    //     [1440633600000, 112.92],
                    //     [1440720000000, 113.29],
                    //     [1440979200000, 112.76],
                    //     /* Sep 2015 */
                    //     [1441065600000, 107.72],
                    //     [1441152000000, 112.34],
                    //     [1441238400000, 110.37],
                    //     [1441324800000, 109.27],
                    //     [1441670400000, 112.31],
                    //     [1441756800000, 110.15],
                    //     [1441843200000, 112.57],
                    //     [1441929600000, 114.21],
                    //     [1442188800000, 115.31],
                    //     [1442275200000, 116.28],
                    //     [1442361600000, 116.41],
                    //     [1442448000000, 113.92],
                    //     [1442534400000, 113.45],
                    //     [1442793600000, 115.21],
                    //     [1442880000000, 113.40],
                    //     [1442966400000, 114.32],
                    //     [1443052800000, 115.00],
                    //     [1443139200000, 114.71],
                    //     [1443398400000, 112.44],
                    //     [1443484800000, 109.06],
                    //     [1443571200000, 110.30],
                    //     /* Oct 2015 */
                    //     [1443657600000, 109.58],
                    //     [1443744000000, 110.38],
                    //     [1444003200000, 110.78],
                    //     [1444089600000, 111.31],
                    //     [1444176000000, 110.78],
                    //     [1444262400000, 109.50],
                    //     [1444348800000, 112.12],
                    //     [1444608000000, 111.60],
                    //     [1444694400000, 111.79],
                    //     [1444780800000, 110.21],
                    //     [1444867200000, 111.86],
                    //     [1444953600000, 111.04],
                    //     [1445212800000, 111.73],
                    //     [1445299200000, 113.77],
                    //     [1445385600000, 113.76],
                    //     [1445472000000, 115.50],
                    //     [1445558400000, 119.08],
                    //     [1445817600000, 115.28],
                    //     [1445904000000, 114.55],
                    //     [1445990400000, 119.27],
                    //     [1446076800000, 120.53],
                    //     [1446163200000, 119.50],
                    //     /* Nov 2015 */
                    //     [1446422400000, 121.18],
                    //     [1446508800000, 122.57],
                    //     [1446595200000, 122.00],
                    //     [1446681600000, 120.92],
                    //     [1446768000000, 121.06],
                    //     [1447027200000, 120.57],
                    //     [1447113600000, 116.77]
                    // ],
                    marker: {
                        enabled: true,
                        radius: 3
                    },
                    shadow: true,
                    tooltip: {
                        valueDecimals: 2,
                    }
                });
                console.log('project.usageChartConfig', project.usageChartConfig);
            };

            var getData = function(project) {
                if (project.selectedUser) {
                    if (project.selectedQueue) {
                        UsageFactory.getAllocationUserQueueUsage(project).then(function() {
                            drawUsageChart(project);
                        });
                    } else {
                        UsageFactory.getAllocationUserUsage(project).then(function() {
                            drawUsageChart(project);
                        });
                    }

                } else if (project.selectedQueue) {
                    UsageFactory.getAllocationQueueUsage(project).then(function() {
                        drawUsageChart(project);
                    });

                } else {
                    UsageFactory.getAllocationUsage(project).then(function() {
                        drawUsageChart(project);
                    });
                }

            };

            $scope.viewUsage = function(project) {
                project.showUPUChart = false;
                project.showChart = true;
                AllocationFactory.getProjectUsers(project);
                getData(project);
            };

            var drawUsageByUsersChart = function(project) {
                project.usageByUserChartConfig = angular.copy(usageByUserChartConfig);
                project.usageByUserChartConfig.title.text = $filter('date')(project.from, 'dd MMMM yyyy') +
                    ' - ' + $filter('date')(project.to, 'dd MMMM yyyy');
                project.usageByUserChartConfig.series = [];
                project.usageByUserChartConfig.options.xAxis.categories = project.selectedAllocation.usageUsers;
                for (var key in project.selectedAllocation.usageByUsers) {
                    project.usageByUserChartConfig.series.push({
                        name: key,
                        data: project.selectedAllocation.usageByUsers[key]
                    });
                }
            };

            var getUsageByUsers = function(project) {
                UsageFactory.getUsageByUsers(project).then(function() {
                    drawUsageByUsersChart(project);
                });
            };

            var setDefaultDates = function(project) {
                project.from = $scope.getMinDate(project);
                project.to = $scope.getMaxDate(project);
            };

            $scope.viewUsagePerUser = function(project) {
                if (!project.from || !project.to) {
                    project.dateRange = 'all';
                    setDefaultDates(project);
                }

                project.showChart = false;
                project.showUPUChart = true;
                getUsageByUsers(project);
            };

            $scope.updateUsageByUsersChart = function(project, dateRange) {
                switch (dateRange) {
                    case '1m':
                        project.dateRange = '1m';
                        project.from = moment().subtract(1, 'months').format('YYYY-MM-DDTHH:mm:ssZ');
                        project.to = moment().format('YYYY-MM-DDTHH:mm:ssZ');
                        break;
                    case '3m':
                        project.dateRange = '3m';
                        project.from = moment().subtract(3, 'months').format('YYYY-MM-DDTHH:mm:ssZ');
                        project.to = moment().format('YYYY-MM-DDTHH:mm:ssZ');
                        break;
                    case '6m':
                        project.dateRange = '6m';
                        project.from = moment().subtract(6, 'months').format('YYYY-MM-DDTHH:mm:ssZ');
                        project.to = moment().format('YYYY-MM-DDTHH:mm:ssZ');
                        break;
                    case 'ytd':
                        project.dateRange = 'ytd';
                        project.from = moment().startOf('year').format('YYYY-MM-DDTHH:mm:ssZ');
                        project.to = moment().format('YYYY-MM-DDTHH:mm:ssZ');
                        break;
                    case '1y':
                        project.dateRange = '1y';
                        project.from = moment().subtract(1, 'years').format('YYYY-MM-DDTHH:mm:ssZ');
                        project.to = moment().format('YYYY-MM-DDTHH:mm:ssZ');
                        break;
                    case 'all':
                        project.dateRange = 'all';
                        setDefaultDates(project);
                        break;
                    default:
                        project.dateRange = 'custom';
                        project.from = moment(project.from).format('YYYY-MM-DDTHH:mm:ssZ');
                        project.to = moment(project.to).format('YYYY-MM-DDTHH:mm:ssZ');
                        break;

                }
                getUsageByUsers(project);
            };

            $scope.viewUserUsage = function(project) {
                project.showChart = true;
                project.selectedUser = {
                    username: $scope.selections.username
                };
                getData(project);
            };

            $scope.updateChart = function(project) {
                getData(project);
            };

            $scope.selections = {
                usernamemodel: '',
                username: ''
            };

            $scope.submitted = false;

            $scope.handleKeyPress = function(e) {
                var key = e.keyCode || e.which;
                if (key === 13) {
                    $scope.getUserAllocations();
                }
            };

            var path = $location.path();
            if (path) {
                $scope.selections.usernamemodel = path.substring(1);
                $scope.getUserAllocations();
            } else {
                $scope.getAllocations();
            }

            $scope.dateOptions = {
                formatYear: 'yy',
                startingDay: 1
            };

            $scope.format = 'dd MMMM yyyy';

            //calendar
            $scope.disabled = function(date, mode) {
                return (false && mode === 'day' && (date.getDay() === 0 || date.getDay() === 6));
            };

            $scope.getMaxDate = function(project) {
                var today = moment().format('YYYY-MM-DDTHH:mm:ssZ');
                if (moment(project.selectedAllocation.end).isAfter(today, 'day')) {
                    return today;
                } else {
                    return moment(project.selectedAllocation.end).format('YYYY-MM-DDTHH:mm:ssZ');
                }
            };

            $scope.getMinDate = function(project) {
                return moment(project.selectedAllocation.start).format('YYYY-MM-DDTHH:mm:ssZ');
            };

            $scope.open = {

            };

            $scope.isOpen = function($event, project, caltype) {
                $event.preventDefault();
                $event.stopPropagation();
                if (caltype === 'start') {
                    project.endOpened = false;
                    project.startOpened = true;
                } else if (caltype === 'end') {
                    project.startOpened = false;
                    project.endOpened = true;
                }

            };

        }
    ]);
