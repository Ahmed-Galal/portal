"use strict";angular.module("underscore",[]).factory("_",function(){return window._}),angular.module("discoveryApp",["underscore","ui.bootstrap","ngClipboard"]).config(["$interpolateProvider","$httpProvider",function(a,b){a.startSymbol("[[").endSymbol("]]"),b.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",b.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",b.defaults.xsrfCookieName="csrftoken",b.defaults.xsrfHeaderName="X-CSRFToken"}]),angular.module("discoveryApp").factory("UtilFactory",["_",function(a){var b={},c={smp_size:"# CPUs",smt_size:"# Cores",ram_size:"RAM (GiB)",cache_l1:"Cache L1 (KiB)",cache_l2:"Cache L2 (KiB)",cache_l3:"Cache L3 (KiB)",cache_l1d:"Cache L1d (KiB)",cache_l1i:"Cache L1i (KiB)",clock_speed:"Clock Speed (GHz)",rate:"Rate (GHz)",size:"Size (GiB)",gpu:"GPU",besteffort:"Best Effort"};return b.isEmpty=function(b){return"undefined"!=typeof b&&b?angular.isArray(b)&&0===b.length?!0:angular.isObject(b)&&a.isEmpty(b)?!0:!1:!0},b.snakeToReadable=function(a){var b=c[a];return b?b:(a+="",a=a.replace(/(_[a-z\d])/g,function(a){return a=isNaN(parseInt(a[1]))?" "+a[1].toUpperCase():" #"+a[1]}),a.charAt(0).toUpperCase()+a.slice(1))},b}]).factory("ResourceFactory",["$q","$http","_","UtilFactory",function(a,b,c,d){var e={};e.formatNode=function(a){delete a.links,delete a.type;try{a.main_memory.ram_size=(a.main_memory.ram_size/1073741824).toFixed(2)}catch(b){}try{"undefined"!=typeof a.processor.cache_l1&&null!==a.processor.cache_l1&&(a.processor.cache_l1=(a.processor.cache_l1/1024).toFixed(2))}catch(b){}try{"undefined"!=typeof a.processor.cache_l2&&null!==a.processor.cache_l2&&(a.processor.cache_l2=(a.processor.cache_l2/1024).toFixed(2))}catch(b){}try{"undefined"!=typeof a.processor.cache_l3&&null!==a.processor.cache_l3&&(a.processor.cache_l3=(a.processor.cache_l3/1024).toFixed(2))}catch(b){}try{"undefined"!=typeof a.processor.cache_l1d&&null!==a.processor.cache_l1d&&(a.processor.cache_l1d=(a.processor.cache_l1d/1024).toFixed(2))}catch(b){}try{"undefined"!=typeof a.processor.cache_l1i&&null!==a.processor.cache_l1i&&(a.processor.cache_l1i=(a.processor.cache_l1i/1024).toFixed(2))}catch(b){}try{"undefined"!=typeof a.processor.clock_speed&&null!==a.processor.clock_speed&&(a.processor.clock_speed=(a.processor.clock_speed/1e9).toFixed(2))}catch(b){}try{var d=a.network_adapters;!c.isEmpty(d)&&d.length>0&&c.each(d,function(a){"undefined"!=typeof a.rate&&null!==a.rate&&(a.rate=(a.rate/1e9).toFixed(2))})}catch(b){}try{var e=a.storage_devices;!c.isEmpty(e)&&e.length>0&&c.each(e,function(a){"undefined"!=typeof a.size&&null!==a.size&&(a.size=(a.size/1073741824).toFixed(2))})}catch(b){}},e.sites=[],e.allNodes=[],e.filters={},e.prunedAppliedFilters={};var f=[];e.getResources=function(d,g,h){d.loading=!0,d.loadingError=!1;var i=b({method:"GET",url:"sites.json",cache:"true"}).then(function(i){return e.sites=i.data.items,c.each(e.sites,function(i,j){var k=i.links,l=c.findWhere(k,{rel:"clusters"});if(l){var m=l.href.substring(1)+".json",n=b({method:"GET",url:m,cache:"true"}).then(function(k){return i.clusters=k.data.items,c.each(i.clusters,function(k,l){var m=k.links,n=c.findWhere(m,{rel:"nodes"});if(n){var o=n.href.substring(1)+".json",p=b({method:"GET",url:o,cache:"true"}).then(function(b){return k.nodes=b.data.items,c.each(k.nodes,function(b,c){b.site=i.uid,b.cluster=k.uid,e.formatNode(b),e.allNodes.push(b),j===e.sites.length-1&&l===i.clusters.length-1&&c===k.nodes.length-1&&a.all(f).then(function(){d.loading=!1,g()})}),b},function(a){return d.loadingError=!0,d.loading=!1,h("There was an error fetching nodes."),a});f.push(p)}else d.loadingError=!0,d.loading=!1,h("Node link is missing.")}),k},function(a){return d.loadingError=!0,d.loading=!1,h("There was an error fetching clusters."),a});f.push(n)}else d.loadingError=!0,d.loading=!1,h("Cluster link is missing.")}),i},function(a){return d.loadingError=!0,d.loading=!1,h("There was an error fetching sites."),a});f.push(i)},e.pruneFilters=function(a,b){var f=a;a="undefined"==typeof a?e.filters:a[b];for(var g in a)if(!c.isObject(a[g])||c.isArray(a[g])||d.isEmpty(a[g]))if(c.isArray(a[g])&&!d.isEmpty(a[g])){if(c.isObject(a[g][0]))for(var h=0;h<a[g].length;h++)e.pruneFilters(a[g],h)}else d.isEmpty(a[g])&&delete a[g];else e.pruneFilters(a,g);d.isEmpty(a)&&"undefined"!=typeof b&&delete f[b]};var g=function(a,b,d){d="undefined"==typeof d?e.filters:d;for(var f in a)if(a.hasOwnProperty(f))if(c.isArray(a[f])){"undefined"==typeof d[f]&&(d[f]=[]);for(var h=0;h<a[f].length;h++)"undefined"==typeof d[f][h]&&(d[f][h]={}),g(a[f][h],b,d[f][h])}else if(c.isObject(a[f]))"undefined"==typeof d[f]&&(d[f]={}),g(a[f],b,d[f]);else if("type"!==f&&"uid"!==f&&"guid"!==f&&"mac"!==f&&"serial"!==f){var i="";d.hasOwnProperty(f)?(i=a[f],null!==i&&""!==i&&("undefined"==typeof d[f][i]&&(d[f][i]=[]),d[f][i].push(b))):(d[f]={},i=a[f],null!==i&&""!==i&&(d[f][i]=[],d[f][i].push(b)))}};return e.processNodes=function(a){e.filters={},d.isEmpty(a)||(c.each(a,function(a){g(a,a.uid)}),e.pruneFilters())},e}]),angular.module("discoveryApp").controller("MainController",["$scope","$http","_","$q","$timeout","ResourceFactory","UtilFactory",function(a,b,c,d,e,f,g){a.snakeToReadable=g.snakeToReadable,a.isArray=function(a){return c.isArray(a)},a.isObject=function(a){return c.isObject(a)},a.contains=function(a,b){return c.contains(a,b)},a.changeView=function(){a.showNodes=!a.showNodes,console.log("$scope.showNodes",a.showNodes)},a.isNestedObject=function(a){if(c.isArray(a))return!1;if(c.isObject(a))for(var b in a)return c.isArray(a[b])?!1:c.isObject(a[b])?!0:!1},a.isArrayOfObjects=function(a){return!c.isArray(a)||c.isEmpty(a)?!1:c.isObject(a[0])?!0:!1},a.shouldDisable=function(b,c){for(var d=null,e=0;e<b.length;e++){var f=b[e];d=null===d?a.appliedFilters[f]:d[f]}return d===!1&&c!==a.filteredNodes.length&&(d=!0),!d};var h=function(b){for(var d in b)if(a.isArrayOfObjects(b[d]))for(var e=b[d].length,f=0;e>f;f++)d+="",h(b[d][f]);else c.isArray(b[d])?b[d]=!1:c.isObject(b[d])&&h(b[d])},i=function(a,b,d){var e=a;a=null===b?a:a[b];for(var f in a)if(!c.isObject(a[f])||c.isArray(a[f])||g.isEmpty(a[f]))if(c.isArray(a[f])&&!g.isEmpty(a[f])){if(c.isObject(a[f][0])){for(var h=a[f].length-1,j=h;j>=0;j--)i(a[f],j,d);c.isEmpty(a[f])&&delete a[f]}}else(g.isEmpty(a[f])||a[f]===!1)&&(c.isArray(a)?d||a.splice(f,1):delete a[f]);else i(a,f,d);g.isEmpty(a)&&"undefined"!=typeof b&&(c.isArray(e)?d||e.splice(b,1):delete e[b])},j=function(){a.filterSite=a.filters.site,delete a.filters.site,a.filterCluster=a.filters.cluster,delete a.filters.cluster,a.filterVersion=a.filters.version,delete a.filters.version,a.filterArchitecture=a.filters.architecture,delete a.filters.architecture,a.filterProcessor=a.filters.processor,delete a.filters.processor,a.filterMainMemory=a.filters.main_memory,delete a.filters.main_memory,a.filterGpu=a.filters.gpu,delete a.filters.gpu,a.filterMonitoring=a.filters.monitoring,delete a.filters.monitoring};f.getResources(a,function(){a.allNodes=f.allNodes,a.filteredNodes=f.allNodes,f.processNodes(a.allNodes),a.filtersOrg=angular.copy(f.filters),a.filters=angular.copy(f.filters),a.appliedFiltersOrg=angular.copy(f.filters),h(a.appliedFiltersOrg),a.appliedFilters=angular.copy(a.appliedFiltersOrg),j()},function(a){console.error(a)});var k=[],l=function(b,d,e){b="undefined"==typeof b?a.prunedAppliedFilters:b[d],e="undefined"==typeof d?a.filtersOrg:e[d];for(var f in b)if(!c.isObject(b[f])||c.isArray(b[f])||g.isEmpty(b[f]))if(c.isArray(b[f])&&!g.isEmpty(b[f])){if(c.isObject(b[f][0]))for(var h=b[f].length-1,i=h;i>=0;i--)l(b[f],i,e[f])}else b[f]===!0&&(f+="",k.push(e[f]));else l(b,f,e)};a.resetFilters=function(){a.filters=angular.copy(a.filtersOrg),a.appliedFilters=angular.copy(a.appliedFiltersOrg),a.filteredNodes=f.allNodes,j()},a.applyFilter=function(){a.prunedAppliedFilters=angular.copy(a.appliedFilters),i(a.prunedAppliedFilters,null,!0),console.log("$scope.prunedAppliedFilters",a.prunedAppliedFilters);var b=angular.copy(a.prunedAppliedFilters);console.log("prunedAppliedFilters",b),f.prunedAppliedFilters=b,k=[],l(),console.log("intersectArray",k);var d=null;k.length>0&&c.each(k,function(a){null===d?d=a:d.length>0&&(d=c.intersection(d,a))}),i(b,null,!1),c.isEmpty(b)?a.filteredNodes=f.allNodes:a.filteredNodes=c.filter(f.allNodes,function(a){return c.contains(d,a.uid)}),f.processNodes(a.filteredNodes),f.filteredNodes=a.filteredNodes,a.filters=angular.copy(f.filters),j(),console.log("$scope.appliedFilters",a.appliedFilters)}}]),angular.module("discoveryApp").controller("ModalController",["$scope","$modal","$log",function(a,b,c){a.userSelections={startDate:"",endDate:"",minNode:"",maxNode:""},a.open=function(){var d=b.open({animation:!0,templateUrl:"template/reserve-modal.html/",controller:"ModalInstanceCtrl",resolve:{userSelections:function(){return a.userSelections}}});d.result.then(function(b){a.userSelections=b},function(){c.info("Modal dismissed at: "+new Date)})}}]),angular.module("discoveryApp").controller("ModalInstanceCtrl",["$scope","$filter","ResourceFactory","$modalInstance","userSelections",function(a,b,c,d,e){a.userSelections=e;var f=c.filteredNodes||c.allNodes;a.maxNodes=f.length,a.showScript=!1;var g="";a.generateScript=function(){var d=c.prunedAppliedFilters;g="",h(d);var e="startDate="+b("date")(a.userSelections.startDate,"yyyy-MM-dd")+"&endDate="+b("date")(a.userSelections.endDate,"yyyy-MM-dd")+"&min="+a.userSelections.minNode+"&max="+a.userSelections.maxNode;g?a.scrpt=g+"&"+e:a.scrpt=e,a.showScript=!0};var h=function(a,b){b=b||"";for(var c in a)if(console.log("key>>>>",c),_.isArray(a[c]))for(var d=a[c],e=0;e<d.length;e++){var f=b+c+"_"+e+"_";h(d[e],f)}else if(_.isObject(a[c])){var i=b+c+"_";h(a[c],i)}else a[c]===!0&&(b=b.substring(0,b.length-1),g+="&"+b+"="+c)};a.getScript=function(){return a.scrpt},a.fallback=function(a){console.log("copy",a)},a.ok=function(){d.close(a.userSelections)},a.cancel=function(){d.dismiss("cancel")},a.getMin=function(){return a.userSelections.minNode||1},a.minDate=new Date,a.open={start:!1,end:!1},a.open=function(b,c){b.preventDefault(),b.stopPropagation(),c=c.toLowerCase(),"start"===c?(a.open.start&&(a.open.start=!1),a.open.start=!0):"end"===c&&(a.open.end&&(a.open.end=!1),a.open.end=!0)},a.dateOptions={formatYear:"yy",startingDay:1},a.format="yyyy-MM-dd"}]);